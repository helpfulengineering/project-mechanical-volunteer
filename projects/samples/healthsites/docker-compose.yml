version: "3.7"

services:
    redis-master:
        image: 'bitnami/redis:5.0'
        environment:
                - ALLOW_EMPTY_PASSWORD=yes

    redis-sentinel:
        image: 'bitnami/redis-sentinel:5.0'
        environment:
                - REDIS_MASTER_HOST=redis-master

    postgres:
        image: 'postgres:12.2-alpine'
        environment:
            - POSTGRES_USER=pybossa
            - POSTGRES_PASSWORD=supersecretpassword

    # initializes the database
    db-init:
       image: 'helpful-pybossa:latest'
       depends_on:
           - postgres
       environment:
           - POSTGRES_URL=postgresql://pybossa:supersecretpassword@postgres/pybossa
           - REDIS_MASTER=mymaster
           - REDIS_SENTINEL=redis-sentinel
       links:
           - postgres:db
       command: sh -c "sleep 5 && python cli.py db_create"

    pybossa-bgworker:
        image: 'helpful-pybossa:latest'
        depends_on:
            - db-init
        environment:
            - POSTGRES_URL=postgresql://pybossa:supersecretpassword@postgres/pybossa
            - REDIS_MASTER=mymaster
            - REDIS_SENTINEL=redis-sentinel
        links:
            - redis-master
            - redis-sentinel
            - postgres
        entrypoint: /entrypoint.sh
        command:  sh -c "python app_context_rqworker.py scheduled_jobs super high medium low email maintenance"

    pybossa-scheduler:
        image: 'helpful-pybossa:latest'
        depends_on: 
            - db-init
        environment:
            - POSTGRES_URL=postgresql://pybossa:supersecretpassword@postgres/pybossa
            - REDIS_MASTER=mymaster
            - REDIS_SENTINEL=redis-sentinel
        links:
            - redis-master
            - redis-sentinel
            - postgres
        entrypoint: /entrypoint.sh
        command:  sh -c "rqscheduler --host redis-master"
    
    # web server
    pybossa_app:
        image: 'helpful-pybossa:latest'
        container_name: pybossa-app
        depends_on:
            - pybossa-bgworker
            - db-init
        environment:
            - POSTGRES_URL=postgresql://pybossa:supersecretpassword@postgres/pybossa
            - REDIS_MASTER=mymaster
            - REDIS_SENTINEL=redis-sentinel
            - HTTPS=on
            - wsgi.url_scheme='https'
            - HEALTHSITES_API_KEY
        links:
            - redis-master
            - redis-sentinel
            - postgres
        ports:
            - "8080:8080"
